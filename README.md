Реализация оплаты через систему PayOnline в сервисе АйЖКХ

Процесс оплаты:

1. До начала оплаты клиент обращается к методу subscribe контроллера Payment и подписывается на канал Faye.

2. Клиент вызывает метод pay контроллера Payment.

3. В зависимости от передаваемых параметров в методе выбирается тип оплаты.
Существует два базовых типа:
Auth - авторизация новой карты в системе (с отправкой всех необходимых реквизитов)
Rebill - отправка параметра rebill_anchor для использования карты хранимой в системе PayOnline.

4. В зависимости от выбранного метода оплаты формируется список параметров, 
задается URL обращения к системе PayOnline (в одном из классов: AuthPayment, RebillPayment).

5. Данные передаются в PayOnline Worker для выполнения запроса к системе Payonline.

6. Класс PayOnlineResponseManager формирует сообщение для отправки на клиент по соответствующему каналу Faye.
В сообщении передается JSON с двумя параметрами: result и message.
Первый приравнивается к одному из трех значений (в зависимости от ответа системы PayOnline)
  success - платеж прошел успешно,
  failure - при проведении платежа возникла ошибка,
  3ds - требуется 3ds авторизация карты.
  
Второй параметр содержит текст сообщения выводимого в alert на клиенте.

Если необходима 3ds авторизация:
Вместе с result клиенту передаются еще четыре параметра: 
pareq, 
ascurl - url, по которыму клиент переходит в web view, 
md. 
Эти параметры приходят в ответе от PayOnline.

termurl - callback url, на который будут отправлены необходимые параметры для завершения оплаты, после того, 
как пользователь введет данные - одноразовый код - в открывшемся web view. (Здесь termurl - это путь
к методу tds_callback контроллера Payment).

В методе tds_callback происходит обработка полученных данных (md, pares), затем данные оправляются в систему PayOnline
для завершения платежа. Ответ от PayOnline обрабатывается в классе TdsResponseManager и отправляются клиенту на канал 
Faye.

В итоге использовать Faye пришлось из-за callback'а при 3ds авторизации. Можно было реализовать то же через push'и
однако в другом проекте столкнулись с "потерей" пуш-уведомлений в процессе их доставки, поэтому отказались.


==========================================================
the_right_answer.js - исправленный код, вызывающий функцию
